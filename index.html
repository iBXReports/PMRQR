<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Operaciones | PMRQR</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <!-- Check Performance Mode Immediately - Default is LITE for all users -->
    <script>
        (function () {
            const mode = localStorage.getItem('performanceMode');
            // Default to 'lite' if not set (new users) or if explicitly set to 'lite'
            if (mode !== 'normal') {
                document.write('<link rel="stylesheet" href="assets/css/lite-theme.css" id="lite-theme-css">');
                document.documentElement.classList.add('lite-mode');
            }
        })();
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        body {
            font-family: 'Outfit', sans-serif;
        }

        .user-dropdown {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background-color: var(--card-bg);
            min-width: 200px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--card-border);
            /* Removed margin-top to fix hover gap */
            backdrop-filter: blur(10px);
        }

        .dropdown-content a,
        .dropdown-content button {
            color: var(--text-color);
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            text-align: left;
            width: 100%;
            background: none;
            border: none;
            font-size: 0.9rem;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Show on Hover OR Active class (Click) */
        /* Modern User Dropdown */
        .user-dropdown {
            position: relative;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 5px;
            border-radius: 30px;
            transition: background 0.2s ease;
        }

        .user-dropdown:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 120%;
            /* Slight offset for better visual separation */
            background: var(--card-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            min-width: 260px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
            animation: fadeInDown 0.2s ease-out;
            padding: 10px;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-content a,
        .dropdown-content button {
            color: var(--text-color);
            padding: 14px 20px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            background: transparent;
            border: none;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.2s ease;
            margin-bottom: 4px;
        }

        .dropdown-content a:last-child,
        .dropdown-content button:last-child {
            margin-bottom: 0;
        }

        /* Hover States with Gradients */
        .dropdown-content a:hover,
        .dropdown-content button:hover {
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            transform: translateX(5px);
            color: var(--primary-color);
        }

        .dropdown-content .logout-btn:hover {
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.1) 0%, rgba(244, 63, 94, 0.1) 100%);
            color: #ef4444;
        }

        /* Icons in Dropdown */
        .dropdown-icon {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        .user-dropdown.active .dropdown-content {
            display: block;
        }

        /* Divider */
        .dropdown-divider {
            height: 1px;
            background: rgba(0, 0, 0, 0.05);
            margin: 8px 10px;
        }

        [data-theme="dark"] .dropdown-divider {
            background: rgba(255, 255, 255, 0.1);
        }


        .timer-display {
            font-size: 4rem;
            font-weight: 800;
            text-align: center;
            font-variant-numeric: tabular-nums;
            color: var(--primary-color);
            margin: 2rem 0;
            text-shadow: 0 0 20px rgba(99, 102, 241, 0.4);
        }

        .status-badge {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 1rem;
        }

        .input-style {
            width: 100%;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--card-border);
            background: var(--input-bg);
            color: var(--text-color);
            font-size: 1rem;
            margin-top: 0.5rem;
        }

        .input-style:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* Mobile Specifics */
        @media (max-width: 1024px) {

            /* 1. ANIMATION NUKE */
            *,
            *::before,
            *::after {
                animation: none !important;
                transition: none !important;
            }

            .float-anim {
                transform: none !important;
            }

            /* 2. LAYOUT */
            .hero-title {
                font-size: 2rem;
            }

            .container {
                padding: 1rem;
            }

            .grid-2 {
                grid-template-columns: 1fr;
            }

            /* Override inline padding for glass containers */
            .glass[style*="padding: 3rem"] {
                padding: 1.5rem !important;
            }

            .desktop-only {
                display: none !important;
            }
        }
    </style>
</head>

<body>

    <nav class="glass" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem;">
        <!-- 1. LOGO -->
        <div class="logo">
            <a href="index.html"><img src="assets/imagenes/logocargo.png" alt="PMRQR Logo" style="height: 50px;"></a>
        </div>

        <!-- 2. USER SESSION INFO -->
        <div id="user-nav-container" class="hidden" style="display: flex; align-items: center; gap: 1rem;">

            <div class="user-dropdown"
                style="position: relative; cursor: pointer; display: flex; align-items: center; gap: 0.8rem;">
                <!-- Name -->
                <div style="text-align: right;">
                    <span id="nav-user-name"
                        style="display: block; font-weight: 700; color: var(--primary-color); font-size: 0.9rem;">Cargando...</span>
                </div>

                <!-- Avatar -->
                <img id="nav-user-avatar" src="assets/imagenes/avatarcargo.png" alt="Avatar"
                    style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--primary-color); object-fit: cover;">

                <!-- Dropdown Menu -->
                <div class="dropdown-content">
                    <a href="profile.html"><span class="dropdown-icon">üòé</span>Ir al Perfil</a>
                    <a href="admin/admin.html" id="nav-admin-link" class="hidden"><span class="dropdown-icon">üõ°Ô∏è</span>
                        Panel Admin</a>
                    <button id="nav-theme-toggle"><span class="dropdown-icon">üåì</span> Cambiar Tema</button>
                    <div class="dropdown-divider"></div>
                    <button id="nav-logout-btn" class="logout-btn" style="color: #ef4444;"><span
                            class="dropdown-icon">üö™</span> Cerrar Sesi√≥n</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div id="loader" class="loader hidden"></div>
        <div id="error-alert" class="alert alert-error hidden"></div>
        <div id="success-alert" class="alert alert-success hidden"></div>

        <!-- STATE 1: SCAN QR -->
        <div id="view-scan" class="glass float-anim"
            style="text-align: center; padding: 3rem; max-width: 600px; margin: 2rem auto;">
            <h1>üëã Hola, <span id="welcome-user-name">Agente</span></h1>
            <p>Escanea un c√≥digo QR del equipo para comenzar.</p>

            <div style="margin: 2rem 0; display: flex; flex-direction: column; gap: 1rem; align-items: center;">
                <button class="btn" onclick="document.getElementById('qr-gallery-input').click()"
                    style="background: var(--secondary-color);">
                    <i class="fas fa-image"></i> Subir QR desde Galer√≠a
                </button>
                <input type="file" id="qr-gallery-input" accept="image/*" style="display: none;"
                    onchange="handleQrUpload(event)">

                <button class="btn" onclick="startCameraScan()">
                    <i class="fas fa-camera"></i> Escanear con C√°mara
                </button>

                <div
                    style="width: 100%; border-top: 1px solid rgba(255,255,255,0.1); margin: 1.5rem 0; padding-top: 1.5rem;">
                    <button class="btn" onclick="openReportManual()"
                        style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4); font-weight: 700;">
                        <i class="fas fa-exclamation-triangle"></i> Informar Incidencia / Falla
                    </button>
                </div>

                <div id="camera-preview-container"
                    style="display: none; width: 100%; max-width: 400px; position: relative;">
                    <video id="camera-video" style="width: 100%; border-radius: 12px;"></video>
                    <canvas id="camera-canvas" style="display: none;"></canvas>
                    <button class="btn btn-secondary" onclick="stopCameraScan()"
                        style="position: absolute; top: 10px; right: 10px; width: auto; padding: 5px 10px; font-size: 0.7rem;">Cerrar</button>
                </div>
            </div>


        </div>

        <!-- STATE 2: FORM (Inicio Operacion) -->
        <div id="view-form-start" class="glass hidden" style="padding: 2rem; max-width: 800px; margin: 0 auto;">
            <h2 style="color: var(--primary-color);">üöÄ Iniciar Operaci√≥n</h2>
            <p class="text-lg">Vas a utilizar el: <strong id="asset-code-display"
                    style="color: var(--primary-color); font-size: 1.3rem;">...</strong></p>

            <form id="start-form" style="margin-top: 2rem;">
                <input type="hidden" name="asset_code" id="input-asset-code">

                <div class="form-group">
                    <label>üìç Ubicaci√≥n Actual</label>
                    <select name="start_location_type" class="input-style" required>
                        <option value="">Seleccione...</option>
                        <option value="Nacional">Terminal Nacional</option>
                        <option value="Internacional">Terminal Internacional</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>üéØ Punto de Retiro</label>
                    <select name="start_point" class="input-style" required>
                        <option value="">Seleccione...</option>
                        <option value="Counter">Counter</option>
                        <option value="Punto">Punto Info</option>
                        <option value="Minsal">Minsal</option>
                        <option value="Embarque">Embarque</option>
                        <option value="Arribo">Arribo</option>
                        <option value="Estacionamientos">Estacionamientos</option>
                        <option value="Remoto">Remoto</option>
                    </select>
                </div>

                <!-- Role/Team is assumed from profile now (Hidden or Read-only?)
                     Prompt said: "jamas pidas seleccionar el rol". 
                     We can omit it from UI and inject it in JS, OR show it read-only.
                     Let's omit from UI to clear clutter, but maybe show "Equipo" if variable. 
                     Prompt didn't explicitly forbid Team selection, but logic implies predefined.
                     Let's keep Team selection for now unless specified otherwise, or ask JS to fill it. 
                     Actually prompt said: "Role will be loaded by chiefs...". 
                     I'll hide Role. I'll Keep Team for now as it wasn't explicitly banned, but usually linked.
                -->
                <div class="form-group">
                    <label>üè¢ Team</label>
                    <select name="team" class="input-style" required>
                        <option value="Team OLA">Team OLA</option>
                        <option value="Team Latam">Team Latam</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>üèÅ Hacia donde te diriges</label>
                    <select name="destination" id="destination-select" class="input-style" required>
                        <option value="">Seleccione...</option>
                        <option value="Counters">Counters</option>
                        <option value="Arribo">Arribo</option>
                        <option value="Embarque">Embarque</option>
                        <option value="Punto">Punto</option>
                        <option value="Remoto">Remoto</option>
                    </select>
                </div>

                <!-- DYNAMIC FLIGHT INFO -->
                <div id="flight-info-section" class="hidden"
                    style="margin-top: 1.5rem; border: 1px solid var(--primary-color); padding: 1rem; border-radius: 8px; background: rgba(99, 102, 241, 0.05);">
                    <h4 style="margin-bottom: 1rem; color: var(--primary-color);">‚úàÔ∏è Detalles de Vuelo</h4>

                    <div class="form-group">
                        <label>üåâ Puente / Puerta</label>
                        <select name="bridge" id="bridge-select" class="input-style">
                            <option value="">Seleccione Puente...</option>
                            <optgroup label="Terminal Nacional">
                                <option value="Puente A">Puente A</option>
                                <option value="Puente B">Puente B</option>
                            </optgroup>
                            <optgroup label="Terminal Internacional">
                                <option value="Puente C">Puente C</option>
                                <option value="Puente D">Puente D</option>
                                <option value="Puente E">Puente E</option>
                                <option value="Puente F">Puente F</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="form-group" id="gate-selection-group">
                        <label>üö™ Gate (Puerta de Embarque)</label>
                        <select name="gate" id="gate-select" class="input-style">
                            <option value="">Seleccione primero un puente...</option>
                        </select>
                    </div>

                    <div class="grid-2">
                        <div class="form-group">
                            <label>üõ´ Aerol√≠nea</label>
                            <select name="airline" class="input-style">
                                <option value="">Seleccione...</option>
                                <option value="LATAM">LATAM</option>
                                <option value="DELTA">DELTA</option>
                                <option value="COPA">COPA</option>
                                <option value="KLM">KLM</option>
                                <option value="AIRFRANCE">AIR FRANCE</option>
                                <option value="AIRCANADA">AIR CANADA</option>
                                <option value="BOA">BOA</option>
                                <option value="LEVEL">LEVEL</option>
                                <option value="QANTAS">QANTAS</option>
                                <option value="BRITISH AIRWAYS">BRITISH AIRWAYS</option>
                                <option value="IBERIA">IBERIA</option>
                                <option value="ARAJET">ARAJET</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>üî¢ N¬∞ Vuelo</label>
                            <input type="text" name="flight_number" class="input-style" placeholder="Ej: LA123">
                        </div>
                    </div>
                </div>

                <div class="grid-2" style="margin-top: 2rem;">
                    <button type="button" id="btn-back-scan" class="btn btn-secondary">Volver Atr√°s ‚Ü©Ô∏è</button>
                    <button type="submit" class="btn">Comenzar Traslado üèÉ‚Äç‚ôÇÔ∏è</button>
                </div>
            </form>
        </div>

        <!-- STATE 3: TIMER (En Curso) -->
        <div id="view-timer" class="glass hidden"
            style="padding: 3rem; max-width: 600px; margin: 2rem auto; text-align: center;">
            <div class="status-badge">üü¢ EN USO</div>
            <h2>Operaci√≥n en Curso</h2>
            <div id="timer" class="timer-display">50:00</div>
            <div class="progress-bar"
                style="height: 6px; background: rgba(255,255,255,0.2); border-radius: 4px; overflow: hidden; margin: 2rem 0;">
                <div id="timer-progress"
                    style="width: 100%; height: 100%; background: var(--primary-color); transition: width 1s linear;">
                </div>
            </div>
            <div style="margin: 2rem 0; display: flex; flex-direction: column; gap: 1rem; align-items: center;">
                <button class="btn" onclick="document.getElementById('qr-gallery-input-return').click()"
                    style="background: var(--secondary-color); font-size: 0.9rem;">
                    <i class="fas fa-image"></i> Devoluci√≥n via Galer√≠a
                </button>
                <input type="file" id="qr-gallery-input-return" accept="image/*" style="display: none;"
                    onchange="handleQrUpload(event, 'return')">

                <button class="btn" onclick="startCameraScan('return')" style="font-size: 0.9rem;">
                    <i class="fas fa-camera"></i> Escanear Devoluci√≥n
                </button>
            </div>


        </div>

        <!-- STATE 4: RETURN FORM (Devolucion) -->
        <div id="view-form-end" class="glass hidden" style="padding: 2rem; max-width: 800px; margin: 0 auto;">
            <h2 style="color: var(--secondary-color);">‚úÖ Finalizar Operaci√≥n</h2>
            <form id="end-form" style="margin-top: 2rem;">
                <div class="grid-2">
                    <div class="form-group">
                        <label>üìç Terminal de Devoluci√≥n</label>
                        <select name="end_location_type" id="end-terminal" class="input-style" required>
                            <option value="">Seleccione...</option>
                            <option value="Nacional">Terminal Nacional</option>
                            <option value="Internacional">Terminal Internacional</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üéØ Punto de Entrega</label>
                        <select name="end_point" id="input-end-point" class="input-style" required>
                            <option value="">Seleccione...</option>
                            <option value="Counter">Counter</option>
                            <option value="Punto">Punto Info</option>
                            <option value="Minsal">Minsal</option>
                            <option value="Embarque">Embarque</option>
                            <option value="Arribo">Arribo</option>
                            <option value="Estacionamientos">Estacionamientos</option>
                            <option value="Remoto">Remoto</option>
                        </select>
                    </div>
                </div>

                <!-- NEW: End Bridge Group -->
                <div class="form-group hidden" id="end-bridge-group">
                    <label>üåâ Seleccione Puente</label>
                    <select name="end_bridge" id="end-bridge-select" class="input-style">
                        <option value="">Seleccione Puente...</option>
                    </select>
                </div>

                <!-- NEW: End Gates Group -->
                <div class="form-group hidden" id="end-gate-group">
                    <label id="end-gate-label">üö™ Gate</label>
                    <select name="end_gate" id="end-gate-select" class="input-style">
                        <option value="">Seleccione Puente primero...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>üì∏ Foto de Respaldo (Obligatorio)</label>
                    <input type="file" name="return_photo" id="return-photo" class="input-style" accept="image/*"
                        capture="environment" required>
                    <p style="font-size: 0.75rem; opacity: 0.6; margin-top: 5px;">Tome una foto al equipo donde lo est√°
                        dejando.</p>
                </div>

                <h3 style="margin-top: 1rem; opacity: 0.7;">Resumen de Entrega</h3>
                <p id="end-resume-display">Cargando datos...</p>

                <button type="submit" class="btn"
                    style="background: linear-gradient(135deg, #10b981, #059669); margin-top: 2rem;">Finalizar y
                    Confirmar Devoluci√≥n ‚úÖ</button>
            </form>
        </div>

        <!-- STATE 5: REPORT INCIDENT (Nuevo) -->
        <div id="view-report" class="glass hidden" style="padding: 2rem; max-width: 800px; margin: 0 auto;">
            <h2 style="color: #f59e0b; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-exclamation-triangle"></i> Reportar Incidencia
            </h2>
            <form id="report-form" style="margin-top: 2rem;">
                <div class="grid-2">
                    <div class="form-group">
                        <label>‚ôø Tipo de Equipo</label>
                        <select name="asset_type" id="report-asset-type" class="input-style" required>
                            <option value="">Seleccione...</option>
                            <option value="Silla De Pasillo">Silla De Pasillo</option>
                            <option value="Silla Oruga">Silla Oruga</option>
                            <option value="Silla De Ruedas">Silla De Ruedas</option>
                            <option value="Carrito de Golf">Carrito de Golf</option>
                            <option value="Carrito Duplex">Carrito Duplex</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üîç Seleccionar Equipo que reporta</label>
                        <select name="asset_code" id="report-asset-select" class="input-style" required disabled>
                            <option value="">Seleccione primero el tipo...</option>
                        </select>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="form-group">
                        <label>üìÇ Categor√≠a de Reporte</label>
                        <select name="report_category" class="input-style" required>
                            <option value="">Seleccione...</option>
                            <option value="Extraviado">Equipos Extraviados</option>
                            <option value="Encontrado">Equipos Encontrados</option>
                            <option value="Roto">Equipos Rotos</option>
                            <option value="Da√±ado">Equipos Da√±ados</option>
                            <option value="Otro">Otros Motivos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üìç Terminal</label>
                        <select name="terminal" id="report-terminal" class="input-style" required>
                            <option value="Nacional">Terminal Nacional</option>
                            <option value="Internacional">Terminal Internacional</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>üè¢ Contexto Ubicaci√≥n</label>
                    <select name="location_context" id="report-context" class="input-style" required>
                        <option value="">Seleccione...</option>
                        <option value="Arribo">Arribo</option>
                        <option value="Counter">Counter</option>
                        <option value="Embarque">Embarque</option>
                        <option value="Estacionamientos">Estacionamientos</option>
                        <option value="Minsal">Minsal</option>
                        <option value="Plaza">Plaza</option>
                        <option value="Punto">Punto</option>
                        <option value="Remoto">Remoto</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>

                <div class="form-group hidden" id="report-gate-group">
                    <label id="report-gate-label">üö™ Gate</label>
                    <select name="gate" id="report-gate-select" class="input-style">
                        <option value="">Seleccione...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>üìù Motivo / Descripci√≥n</label>
                    <textarea name="description" class="input-style" style="height: 100px;"
                        placeholder="Explique brevemente lo sucedido..." required></textarea>
                </div>

                <div class="form-group">
                    <label>üì∏ Evidencia Fotogr√°fica</label>
                    <input type="file" name="photo" id="report-photo" class="input-style" accept="image/*"
                        capture="environment">
                    <p style="font-size: 0.75rem; opacity: 0.6; margin-top: 5px;">Puedes tomar una foto o subir una de
                        la galer√≠a.</p>
                </div>

                <div class="grid-2" style="margin-top: 2rem;">
                    <button type="button" onclick="showView('view-scan')" class="btn btn-secondary">Cancelar</button>
                    <button type="submit" class="btn" style="background: #f59e0b;">Enviar Reporte üöÄ</button>
                </div>
            </form>
        </div>

    </div>

    <footer class="app-footer">
        CREADO CON <span>‚ù§Ô∏è</span> POR IAN SAAVEDRA PARA CARGOMOBILITY
    </footer>

    <script type="module" src="assets/js/client.js"></script>
    <script type="module" src="assets/js/common.js"></script>
    <script type="module" src="assets/js/operations.js"></script>
    <script src="assets/js/qr_handler.js"></script>

    <script>
        window.simulateScan = (code) => {
            const event = new CustomEvent('qr-scanned', { detail: code });
            window.dispatchEvent(event);
        };
        window.simulateReturn = (point) => {
            const event = new CustomEvent('qr-return-scanned', { detail: point });
            window.dispatchEvent(event);
        }
    </script>
</body>

</html>