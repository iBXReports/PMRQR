<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Errores | PMRQR</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/lite-theme.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
        }

        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .test-section {
            margin-bottom: 2rem;
        }

        .test-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .test-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .status-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .status-pending {
            background: #fbbf24;
            color: white;
        }

        .status-success {
            background: #10b981;
            color: white;
        }

        .status-error {
            background: #ef4444;
            color: white;
        }

        .test-result {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            padding: 1rem;
            font-family: monospace;
            font-size: 0.85rem;
            max-height: 200px;
            overflow: auto;
            white-space: pre-wrap;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .summary-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }

        .summary-card h3 {
            font-size: 2rem;
            margin: 0;
        }

        .summary-card p {
            margin: 0.5rem 0 0;
            opacity: 0.7;
        }

        .summary-total {
            border-left: 4px solid var(--primary-color);
        }

        .summary-success {
            border-left: 4px solid #10b981;
        }

        .summary-error {
            border-left: 4px solid #ef4444;
        }

        .btn-run {
            background: linear-gradient(135deg, #6366f1, #a855f7);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-run:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }
    </style>
</head>

<body data-theme="dark">
    <nav class="glass">
        <div class="logo">
            <img src="assets/imagenes/logocargo.png" alt="PMRQR Logo">
        </div>
        <div class="nav-links">
            <button id="theme-toggle" class="theme-toggle">üåô</button>
            <a href="index.html">Volver</a>
        </div>
    </nav>

    <div class="test-container">
        <h1 style="margin-bottom: 0.5rem;">üß™ Test de Errores - PMRQR</h1>
        <p style="opacity: 0.7; margin-bottom: 2rem;">Diagn√≥stico completo del sistema y base de datos</p>

        <!-- Summary Cards -->
        <div class="summary-grid">
            <div class="summary-card summary-total">
                <h3 id="total-tests">0</h3>
                <p>Tests Totales</p>
            </div>
            <div class="summary-card summary-success">
                <h3 id="passed-tests">0</h3>
                <p>Pasados</p>
            </div>
            <div class="summary-card summary-error">
                <h3 id="failed-tests">0</h3>
                <p>Fallidos</p>
            </div>
        </div>

        <!-- Run Tests Button -->
        <button class="btn-run" onclick="runAllTests()">
            <i class="fas fa-play"></i> Ejecutar Todos los Tests
        </button>

        <!-- Test Sections -->
        <div id="test-results" style="margin-top: 2rem;"></div>
    </div>

    <script type="module">
        import { supabase } from './assets/js/client.js';
        window.supabase = supabase;
    </script>

    <script>
        // Test definitions
        const tests = [
            {
                name: "Conexi√≥n a Supabase",
                category: "Conexi√≥n",
                run: async () => {
                    const { data, error } = await window.supabase.from('profiles').select('id').limit(1);
                    if (error) throw new Error(error.message);
                    return "Conexi√≥n exitosa a Supabase";
                }
            },
            {
                name: "Tabla: profiles",
                category: "Base de Datos",
                run: async () => {
                    const { data, error } = await window.supabase.from('profiles').select('*').limit(5);
                    if (error) throw new Error(error.message);
                    return `Tabla accesible. ${data.length} registros encontrados.`;
                }
            },
            {
                name: "Tabla: assets",
                category: "Base de Datos",
                run: async () => {
                    const { data, error } = await window.supabase.from('assets').select('*').limit(5);
                    if (error) throw new Error(error.message);
                    return `Tabla accesible. ${data.length} activos encontrados.`;
                }
            },
            {
                name: "Tabla: operations",
                category: "Base de Datos",
                run: async () => {
                    const { data, error } = await window.supabase.from('operations').select('*').limit(5);
                    if (error) throw new Error(error.message);
                    return `Tabla accesible. ${data.length} operaciones encontradas.`;
                }
            },
            {
                name: "Tabla: reports",
                category: "Base de Datos",
                run: async () => {
                    const { data, error } = await window.supabase.from('reports').select('*').limit(5);
                    if (error) throw new Error(error.message);
                    return `Tabla accesible. ${data.length} reportes encontrados.`;
                }
            },
            {
                name: "Tabla: airlines",
                category: "Configuraci√≥n",
                run: async () => {
                    const { data, error } = await window.supabase.from('airlines').select('*');
                    if (error) throw new Error(error.message);
                    return `Tabla accesible. ${data.length} aerol√≠neas configuradas.`;
                }
            },
            {
                name: "Tabla: locations",
                category: "Configuraci√≥n",
                run: async () => {
                    const { data, error } = await window.supabase.from('locations').select('*');
                    if (error) throw new Error(error.message);
                    return `Tabla accesible. ${data.length} ubicaciones configuradas.`;
                }
            },
            {
                name: "Tabla: app_settings",
                category: "Configuraci√≥n",
                run: async () => {
                    const { data, error } = await window.supabase.from('app_settings').select('*');
                    if (error) throw new Error(error.message);
                    return `Tabla accesible. ${data.length} configuraciones guardadas.`;
                }
            },
            {
                name: "Autenticaci√≥n Actual",
                category: "Autenticaci√≥n",
                run: async () => {
                    const { data: { session } } = await window.supabase.auth.getSession();
                    if (session) {
                        return `Usuario autenticado: ${session.user.email}`;
                    } else {
                        return "No hay sesi√≥n activa (visitante)";
                    }
                }
            },
            {
                name: "Storage: Bucket 'uploads'",
                category: "Storage",
                run: async () => {
                    const { data, error } = await window.supabase.storage.from('uploads').list('', { limit: 1 });
                    if (error) throw new Error(error.message);
                    return "Bucket 'uploads' accesible";
                }
            },
            {
                name: "Columnas de Operations",
                category: "Esquema",
                run: async () => {
                    const { data, error } = await window.supabase.from('operations').select('id, user_id, asset_id, start_time, bridge, gate, airline, flight_number, end_gate').limit(1);
                    if (error) throw new Error(error.message);
                    return "Todas las columnas esperadas existen";
                }
            },
            {
                name: "Columnas de Profiles",
                category: "Esquema",
                run: async () => {
                    const { data, error } = await window.supabase.from('profiles').select('id, username, full_name, email, role, team, cert_golf, cert_duplex, cert_oruga').limit(1);
                    if (error) throw new Error(error.message);
                    return "Todas las columnas esperadas existen";
                }
            },
            {
                name: "Operaciones Activas",
                category: "Estado",
                run: async () => {
                    const { data, error, count } = await window.supabase.from('operations').select('*', { count: 'exact' }).eq('status', 'active');
                    if (error) throw new Error(error.message);
                    return `${data.length} operaciones activas en este momento`;
                }
            },
            {
                name: "Activos Disponibles",
                category: "Estado",
                run: async () => {
                    const { data, error } = await window.supabase.from('assets').select('*').eq('status', 'available');
                    if (error) throw new Error(error.message);
                    return `${data.length} activos disponibles`;
                }
            },
            {
                name: "Activos en Uso",
                category: "Estado",
                run: async () => {
                    const { data, error } = await window.supabase.from('assets').select('*').eq('status', 'in_use');
                    if (error) throw new Error(error.message);
                    return `${data.length} activos en uso`;
                }
            }
        ];

        // Render initial state
        function renderTests() {
            const container = document.getElementById('test-results');
            const categories = [...new Set(tests.map(t => t.category))];

            let html = '';
            categories.forEach(cat => {
                html += `<div class="test-section"><h2>${cat}</h2>`;
                tests.filter(t => t.category === cat).forEach((test, idx) => {
                    html += `
                        <div class="test-card" id="test-${test.name.replace(/\s/g, '-')}">
                            <div class="test-title">
                                <span class="status-icon status-pending" id="icon-${test.name.replace(/\s/g, '-')}">‚è≥</span>
                                ${test.name}
                            </div>
                            <div class="test-result" id="result-${test.name.replace(/\s/g, '-')}">Esperando ejecuci√≥n...</div>
                        </div>
                    `;
                });
                html += '</div>';
            });

            container.innerHTML = html;
            document.getElementById('total-tests').textContent = tests.length;
        }

        // Run all tests
        window.runAllTests = async function () {
            let passed = 0;
            let failed = 0;

            for (const test of tests) {
                const id = test.name.replace(/\s/g, '-');
                const icon = document.getElementById('icon-' + id);
                const result = document.getElementById('result-' + id);

                icon.className = 'status-icon status-pending';
                icon.textContent = '‚è≥';
                result.textContent = 'Ejecutando...';

                try {
                    const output = await test.run();
                    icon.className = 'status-icon status-success';
                    icon.textContent = '‚úì';
                    result.textContent = '‚úÖ ' + output;
                    passed++;
                } catch (err) {
                    icon.className = 'status-icon status-error';
                    icon.textContent = '‚úó';
                    result.textContent = '‚ùå ERROR: ' + err.message;
                    failed++;
                }
            }

            document.getElementById('passed-tests').textContent = passed;
            document.getElementById('failed-tests').textContent = failed;
        };

        // Initialize
        renderTests();
    </script>

    <script src="assets/js/common.js" type="module"></script>
</body>

</html>